<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Nivelación MAE</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons (Solo para iconos) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // La función createIcons se hace global para ser usada después de renderizar el HTML.
        window.createIcons = () => {
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            } else {
                console.warn('Lucide no está cargado o createIcons no está disponible.');
            }
        };
    </script>

    <!-- MathJax CDN para renderizar LaTeX -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [
                    ['$', '$'],
                    ['\\(', '\\)']
                ]
            },
            svg: {
                fontCache: 'global'
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    window.isMathJaxReady = true;
                    document.dispatchEvent(new Event('mathjax-ready'));
                }
            }
        };
    </script>
    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* Estilos generales y fuente */
        body {
            font-family: 'Inter', sans-serif;
        }

        .topic-card {
            min-height: 160px;
        }

        /* Animaciones para el confeti */
        @keyframes fall {
            0% {
                transform: translateY(-100px) rotate(0deg) translateX(0);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(720deg) translateX(calc(var(--rand-x) * 100vw));
                opacity: 0;
            }
        }

        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 60;
            overflow: hidden;
        }

        /* Fix de relleno de estrellas para Tailwind */
        .fill-emerald-500 {
            fill: #10b981;
        }

        .fill-amber-500 {
            fill: #f59e0b;
        }

        .fill-red-600 {
            fill: #dc2626;
        }

        .stroke-emerald-500 {
            stroke: #10b981;
        }

        .stroke-amber-500 {
            stroke: #f59e0b;
        }

        .stroke-red-600 {
            stroke: #dc2626;
        }

        .stroke-gray-300 {
            stroke: #d1d5db;
        }

        .fill-gray-300 {
            fill: #d1d5db;
        }

        /* Estilos para el texto generado por MathJax/LaTeX */
        .MathJax {
            font-size: 1.1em !important;
            line-height: 1.6 !important;
        }

        /* Estilos del modal para mejor lectura */
        .modal-content strong {
            font-weight: 700;
        }

        .modal-content ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            padding-left: 0;
        }

        .modal-content li {
            margin-bottom: 0.5rem;
        }

        .modal-content p {
            margin-bottom: 1rem;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900">

    <div id="confetti-container" class="confetti-container hidden"></div>
    <!-- Estructura inicial (solo el loading) -->
    <div id="app" class="p-4 sm:p-8">
        <div class="text-center p-10">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mx-auto"></div>
            <p class="mt-4 text-indigo-700 font-semibold">Cargando la aplicación y datos...</p>
        </div>
    </div>

    <!-- Contenedor para el modal -->
    <div id="modal-root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // setLogLevel('Debug'); // Descomentar para debug de Firestore

        // --- Configuración Global ---
        const GLOBAL_CONSTANTS = {
            STORAGE_KEY: 'maePrerequisitesStateHTMLV2',
            API_KEY: "",
            APP_ID: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id',
            FIREBASE_CONFIG: typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null,
            INITIAL_AUTH_TOKEN: typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null,
        };
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GLOBAL_CONSTANTS.API_KEY}`;


        // Inicialización de Firebase (si la configuración existe)
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        if (GLOBAL_CONSTANTS.FIREBASE_CONFIG) {
            app = initializeApp(GLOBAL_CONSTANTS.FIREBASE_CONFIG);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Manejo de autenticación y carga de datos
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    // Intento de inicio de sesión
                    if (GLOBAL_CONSTANTS.INITIAL_AUTH_TOKEN) {
                        try {
                            await signInWithCustomToken(auth, GLOBAL_CONSTANTS.INITIAL_AUTH_TOKEN);
                            return;
                        } catch (error) {
                            console.error("Error al iniciar sesión con token personalizado:", error);
                            try {
                                const anonymousUser = await signInAnonymously(auth);
                                user = anonymousUser.user;
                            } catch (anonError) {
                                console.error("Error al iniciar sesión anónimamente:", anonError);
                            }
                        }
                    } else {
                        try {
                            const anonymousUser = await signInAnonymously(auth);
                            user = anonymousUser.user;
                        } catch (anonError) {
                            console.error("Error al iniciar sesión anónimamente:", anonError);
                        }
                    }
                }

                if (user) {
                    userId = user.uid;
                } else {
                    userId = crypto.randomUUID();
                }

                isAuthReady = true;
                window.setGlobalUserId(userId);

                // 2. Definición del path de Firestore para el progreso
                const progressPath = `artifacts/${GLOBAL_CONSTANTS.APP_ID}/users/${userId}/progress/mae_prereq`;

                // 3. Carga de datos inicial y suscripción a cambios
                window.loadStateFromFirestore(db, progressPath);

                // 4. Mostrar la aplicación cuando la autenticación y carga comiencen
                window.initializeAppStructure();
            });
        } else {
            // Modo de fallback (Sin Firebase, solo localStorage)
            console.warn("Firebase no configurado. Usando localStorage como fallback.");
            isAuthReady = true;
            window.loadStateFromLocalStorage();
            window.initializeAppStructure();
        }

        // Exponer funciones necesarias al ámbito global
        window.db = db;
        window.auth = auth;
        window.getFirestorePath = () => `artifacts/${GLOBAL_CONSTANTS.APP_ID}/users/${userId}/progress/mae_prereq`;

        // Exportar funciones de Firestore
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
    </script>

    <script>
        const STORAGE_KEY = 'maePrerequisitesStateHTMLV2';
        const apiKey = ""; // Dejar vacío para el entorno de Canvas.
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- Definición de Temas (42 Temas) ---
        const PRE_REQUISITES = [
            // Aritmética y Álgebra (23 Temas)
            {
                area: "Aritmética y álgebra",
                topic: "Conjuntos de números $ ( \\mathbb{N}, \\mathbb{Z}, \\mathbb{Q}, \\mathbb{R} ) $",
                example: "Diferenciar entre números enteros, racionales e irracionales, p. ej., $\\pi$ vs $\\displaystyle\\frac{22}{7}$.",
                difficulty: 'easy'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Unidades de medida y derivadas",
                example: "Convertir $10 \\text{ km/h}$ a $\\text{m/s}$ o calcular el área en $\\text{m}^2$.",
                difficulty: 'medium'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Aproximaciones: redondeo y cifras significativas",
                example: "Redondear $12.345$ a $3$ cifras significativas.",
                difficulty: 'easy'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Valor absoluto y su uso elemental $|x|$",
                example: "Calcular $|-5-2|$ o resolver $|x| = 7$.",
                difficulty: 'easy'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Operaciones con enteros, decimales y fracciones",
                example: "Resolver $\\displaystyle\\frac{1}{3} + \\displaystyle\\frac{2}{5}$ o $-4 \\cdot (-3)$.",
                difficulty: 'easy'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Primos, factores, múltiplos (m.c.d. y m.c.m. - solo NS)",
                example: "Encontrar el m.c.m. o m.c.d. de $12$ y $18$.",
                difficulty: 'medium'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Razones, porcentajes y proporciones",
                example: "Si un producto cuesta $50\\$$ con un $10\\%$ de descuento, ¿cuál es el precio final?",
                difficulty: 'medium'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Manejo de expresiones: factorización y desarrollo",
                example: "Expandir $(x+3)^2$ o factorizar $x^2 - 4x + 3$.",
                difficulty: 'medium'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Potencias con exponente entero y racional (solo NS)",
                example: "Calcular $2^{-3}$ o $8^{1/3}$.",
                difficulty: 'medium'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Leyes de logaritmos y exponenciales",
                example: "Aplicar las leyes para simplificar $\\log_b(xy)$ o resolver $3^x = 9$.",
                difficulty: 'hard'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Inecuaciones lineales (notación y solución)",
                example: "Resolver $2x - 1 < 5$ y representar el resultado.",
                difficulty: 'medium'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Simplificación de expresiones con radicales",
                example: "Simplificar $\\sqrt{50}$ o $\\sqrt{x^2}$.",
                difficulty: 'medium'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Ecuaciones y sistemas: lineales y cuadráticas (solo NS)",
                example: "Resolver la cuadrática $x^2 + 5x + 6 = 0$ o el sistema: $$\\begin{cases} 2x+y=5 \\\\ x-y=1 \\end{cases}$$",
                difficulty: 'hard'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Teoría de conjuntos (notación básica, unión, intersección)",
                example: "Dado $A = \\{1, 2, 3\\}$ y $B = \\{3, 4\\}$, encontrar $A \\cap B$.",
                difficulty: 'easy'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Fórmulas de cambio de base logarítmica (solo NS)",
                example: "Convertir $\\log_2(8)$ a logaritmo natural: $\\displaystyle\\frac{\\ln(8)}{\\ln(2)}$",
                difficulty: 'hard'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Progresiones aritméticas básicas",
                example: "Encontrar el término 'n' de una secuencia como $2, 5, 8, 11, ...$.",
                difficulty: 'medium'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Progresiones geométricas básicas",
                example: "Calcular la suma finita de una secuencia como $1, 2, 4, 8, ...$.",
                difficulty: 'hard'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Ecuaciones con valor absoluto $|x|$",
                example: "Resolver ecuaciones como $|2x - 1| = 5$.",
                difficulty: 'hard'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Inecuaciones cuadráticas (solo NS)",
                example: "Resolver $x^2 - 4 > 0$ e interpretar la solución en la recta numérica.",
                difficulty: 'hard'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Expresiones algebraicas racionales",
                example: "Simplificar expresiones como $\\displaystyle\\frac{x^2-1}{x-1}$.",
                difficulty: 'medium'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Identidades notables",
                example: "Reconocer y aplicar $(a+b)^2 = a^2 + 2ab + b^2$ y $a^2 - b^2 = (a-b)(a+b)$.",
                difficulty: 'easy'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Cálculo de la pendiente y ecuaciones de la recta",
                example: "Encontrar la pendiente entre dos puntos y escribir la ecuación en forma $y = mx+c$.",
                difficulty: 'medium'
            },
            {
                area: "Aritmética y álgebra",
                topic: "Método de la sustitución y eliminación para sistemas lineales 3x3 (solo NS)",
                example: "Resolver un sistema simple de tres ecuaciones con tres incógnitas.",
                difficulty: 'hard'
            },
            // Funciones (2 Temas)
            {
                area: "Funciones",
                topic: "Representación gráfica de funciones lineales y cuadráticas",
                example: "Dibujar la gráfica de $y = 2x - 3$ y $y = x^2$.",
                difficulty: 'medium'
            },
            {
                area: "Funciones",
                topic: "Concepto de aplicación, dominio y rango",
                example: "Identificar el dominio y rango de una función simple, p. ej., $f(x) = \\sqrt{x}$.",
                difficulty: 'hard'
            },
            // Geometría y Trigonometría (12 Temas)
            {
                area: "Geometría y trigonometría",
                topic: "Teorema de Pitágoras y su recíproco",
                example: "Encontrar la hipotenusa de un triángulo con catetos $3$ y $4$.",
                difficulty: 'easy'
            },
            {
                area: "Geometría y trigonometría",
                topic: "Punto medio y distancia entre dos puntos",
                example: "Calcular la distancia entre $(1, 2)$ y $(4, 6)$.",
                difficulty: 'easy'
            },
            {
                area: "Geometría y trigonometría",
                topic: "Conceptos básicos: recta, plano, ángulo y medición en grados",
                example: "Identificar ángulos complementarios o suplementarios.",
                difficulty: 'easy'
            },
            {
                area: "Geometría y trigonometría",
                topic: "Razones trigonométricas en triángulos rectángulos (SOH CAH TOA)",
                example: "Calcular $\\text{sen}(\\theta), \\text{cos}(\\theta)$ o $\\text{tan}(\\theta)$ dados los lados.",
                difficulty: 'medium'
            },
            {
                area: "Geometría y trigonometría",
                topic: "Transformaciones geométricas: traslación, simetría, rotación, homotecia",
                example: "Reflejar un punto sobre el eje $y$.",
                difficulty: 'medium'
            },
            {
                area: "Geometría y trigonometría",
                topic: "Círculo: centro, radio, área y circunferencia",
                example: "Calcular el área de un círculo con radio $5$.",
                difficulty: 'easy'
            },
            {
                area: "Geometría y trigonometría",
                topic: "Área y perímetro de figuras planas",
                example: "Calcular el área de un trapecio o de una figura compuesta.",
                difficulty: 'medium'
            },
            {
                area: "Geometría y trigonometría",
                topic: "Volumen y área superficial de figuras 3D",
                example: "Calcular el volumen de un cilindro o el área superficial de una esfera.",
                difficulty: 'hard'
            },
            {
                area: "Geometría y trigonometría",
                topic: "Identidades trigonométricas fundamentales",
                example: "Aplicar la identidad $\\sin^2(\\theta) + \\cos^2(\\theta) = 1$.",
                difficulty: 'hard'
            },
            {
                area: "Geometría y trigonometría",
                topic: "Ley del seno y Ley del coseno",
                example: "Resolver un triángulo no rectángulo con lados conocidos.",
                difficulty: 'hard'
            },
            {
                area: "Geometría y trigonometría",
                topic: "Medida de ángulos en radianes",
                example: "Convertir $90^{\\circ}$ a $\\pi/2$ radianes.",
                difficulty: 'medium'
            },
            {
                area: "Geometría y trigonometría",
                topic: "Pendiente de rectas paralelas y perpendiculares",
                example: "Encontrar la pendiente de una recta perpendicular a $y = 3x + 1$.",
                difficulty: 'medium'
            },
            // Estadística y Probabilidad (5 Temas)
            {
                area: "Estadística y probabilidad",
                topic: "Recopilación y representación de datos",
                example: "Crear un histograma o diagrama de barras a partir de una tabla de frecuencias.",
                difficulty: 'easy'
            },
            {
                area: "Estadística y probabilidad",
                topic: "Probabilidad básica (eventos, mut. excluyentes)",
                example: "Calcular la probabilidad de la unión de dos eventos $P(A \\cup B)$.",
                difficulty: 'medium'
            },
            {
                area: "Estadística y probabilidad",
                topic: "Medidas de tendencia central",
                example: "Calcular la media, mediana y moda de un conjunto de datos simple.",
                difficulty: 'easy'
            },
            {
                area: "Estadística y probabilidad",
                topic: "Medidas de dispersión (rango, cuartiles, DS - solo NS)",
                example: "Calcular el rango y los cuartiles para un conjunto de $10$ números.",
                difficulty: 'hard'
            },
            {
                area: "Estadística y probabilidad",
                topic: "Diagramas de Venn para probabilidades",
                example: "Usar un diagrama de Venn para visualizar la intersección de dos conjuntos.",
                difficulty: 'medium'
            },
            // Análisis (1 Tema)
            {
                area: "Análisis",
                topic: "Tasa de Cambio: Velocidad media",
                example: "Calcular la velocidad media de un objeto que recorre $100\\text{ km}$ en $2\\text{ horas}$: $\\text{Velocidad} = \\dfrac{\\text{distancia}}{\\text{tiempo}}$.",
                difficulty: 'easy'
            },
        ];

        const INITIAL_TOPICS = PRE_REQUISITES.map((item, index) => ({
            ...item,
            id: index,
            status: 'initial', // 'initial', 'ready', 'review'
        }));

        // --- Estado Global ---
        let state = {
            topics: INITIAL_TOPICS,
            filterArea: 'all',
            filterDifficulty: 'all',
            filterStatus: 'all',
            currentTopicForModal: null,
            showResetConfirmation: false,
            isMathJaxReady: false,
            userId: null,
            isReady: false,
            hasInitializedStructure: false, // Nuevo: para el renderizado inicial
        };

        // --- Funciones de Utilidad y Firebase ---

        window.setGlobalUserId = (id) => {
            state.userId = id;
            state.isReady = true;
        };

        /**
         * Persiste el estado actual en Firestore (o LocalStorage si no hay Firebase).
         */
        async function saveState() {
            const stateToSave = state.topics.map(t => ({
                id: t.id,
                status: t.status
            }));

            if (window.db && state.userId) {
                try {
                    const progressPath = window.getFirestorePath();
                    await window.setDoc(window.doc(window.db, progressPath), {
                        progress: stateToSave,
                        updatedAt: new Date(),
                    }, {
                        merge: true
                    });
                } catch (e) {
                    console.error("Error al guardar en Firestore, recurriendo a LocalStorage:", e);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
                    // Ejecutar re-renderizado manual en caso de fallback local
                    renderApp();
                }
            } else {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
                renderApp(); // Ejecutar re-renderizado manual
            }
        }

        /**
         * Carga el estado desde Firestore (con fallback a LocalStorage).
         */
        window.loadStateFromFirestore = (db, progressPath) => {
            if (!db || !progressPath) {
                window.loadStateFromLocalStorage();
                return;
            }

            window.onSnapshot(window.doc(db, progressPath), (docSnapshot) => {
                let loadedProgress = null;

                if (docSnapshot.exists() && docSnapshot.data() && docSnapshot.data().progress) {
                    loadedProgress = docSnapshot.data().progress;
                } else {
                    const localData = localStorage.getItem(STORAGE_KEY);
                    if (localData) {
                        try {
                            loadedProgress = JSON.parse(localData);
                            if (loadedProgress.length > 0) {
                                saveState();
                            }
                        } catch (e) {
                            console.error("Error al parsear LocalStorage.", e);
                        }
                    }
                }

                if (loadedProgress) {
                    state.topics = INITIAL_TOPICS.map(initialTopic => {
                        const savedTopic = loadedProgress.find(t => t.id === initialTopic.id);
                        return savedTopic ? {
                            ...initialTopic,
                            status: savedTopic.status || 'initial'
                        } : initialTopic;
                    });
                }

                state.isReady = true;
                renderApp(); // Re-renderizar la UI con los datos cargados
            }, (error) => {
                console.error("Error al escuchar cambios en Firestore:", error);
                window.loadStateFromLocalStorage();
                renderApp();
            });
        };

        /**
         * Carga el estado desde LocalStorage (Solo fallback).
         */
        window.loadStateFromLocalStorage = () => {
            const savedState = localStorage.getItem(STORAGE_KEY);
            if (savedState) {
                try {
                    const parsedState = JSON.parse(savedState);
                    state.topics = INITIAL_TOPICS.map(initialTopic => {
                        const savedTopic = parsedState.find(t => t.id === initialTopic.id);
                        return savedTopic ? {
                            ...initialTopic,
                            status: savedTopic.status || 'initial'
                        } : initialTopic;
                    });
                } catch (e) {
                    console.error("Error al cargar estado local, reiniciando:", e);
                    state.topics = INITIAL_TOPICS;
                }
            }
            state.isReady = true;
        };

        /**
         * Maneja la llamada a la API con Backoff Exponencial.
         */
        const exponentialBackoffFetch = async (url, options, retries = 5, delay = 1000) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    // Manejo de errores HTTP específicos para reintento
                    if (response.status >= 500) {
                        throw new Error(`Server error! status: ${response.status}`);
                    }
                    throw new Error(`Client error! status: ${response.status}`);
                } catch (error) {
                    if (i === retries - 1 || error.message.includes('Client error')) {
                        console.error("Fallo al obtener la respuesta después de múltiples reintentos:", error);
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
            throw new Error("Máximo número de reintentos alcanzado.");
        };

        /**
         * Genera un SVG de estrella para el indicador de dificultad (Simplificado).
         */
        function getDifficultyStars(difficulty) {
            const totalStars = 3;
            let filledStars = 0;
            let colorClass = 'text-gray-400';

            if (difficulty === 'easy') {
                filledStars = 1;
                colorClass = 'text-emerald-500';
            } else if (difficulty === 'medium') {
                filledStars = 2;
                colorClass = 'text-amber-500';
            } else if (difficulty === 'hard') {
                filledStars = 3;
                colorClass = 'text-red-600';
            }

            // Extraer solo el color para el relleno
            const baseColor = colorClass.replace('text-', '');

            let starsHTML = '';
            for (let i = 0; i < totalStars; i++) {
                const isFilled = i < filledStars;
                const classes = isFilled ? `fill-${baseColor} stroke-${baseColor}` : 'fill-none stroke-gray-300';

                // Usar div con data-lucide para que createIcons lo reemplace por el SVG
                starsHTML += `<div data-lucide="star" class="h-4 w-4 transition-colors duration-200 ${classes}" stroke-width="1.5"></div>`;
            }

            return `<div class="flex items-center space-x-0.5" title="Dificultad: ${difficulty.toUpperCase()}">${starsHTML}</div>`;
        }

        /**
         * Convierte una cadena de Markdown simple a HTML para el contenido de IA.
         * Se ha modificado para asegurar que los bloques MathJax ($$..$$) no se envuelvan
         * en etiquetas <p> o <br>.
         */
        const markdownToHtml = (md) => {
            let html = md;

            // 1. ISOLATE: Extract MathJax blocks ($$...$$) into a map and replace with placeholders.
            // This prevents the newlines inside/around it from being converted to <p> tags later.
            const mathBlocks = [];
            // Use [\s\S]*? to correctly match multiline content between $$...$$
            html = html.replace(/\$\$([\s\S]*?)\$\$/g, (match, content) => {
                const placeholder = `MATHBLOCK_PLACEHOLDER_${mathBlocks.length}`;
                mathBlocks.push(content.trim());
                // Use a DIV container and add newlines for clean separation before paragraph conversion
                return `\n\n<div class="math-block-container">${placeholder}</div>\n\n`;
            });

            // Reemplazar encabezados H1/H2/H3/H4 con negrita grande para simplicidad en el modal
            html = html.replace(/^#+ (.+)/gim, '<strong>$1</strong>');

            // Negrita (**) -> <strong>
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Itálica (_) -> <em>
            html = html.replace(/_(.*?)_/g, '<em>$1</em>');

            // Listas no ordenadas (* o -)
            // Primero, convertir elementos de lista a <li>
            html = html.replace(/^[\*-] (.*$)/gim, '<li>$1</li>');

            // Segundo, envolver las secuencias de <li> en <ul>.
            html = html.replace(/(<li>.*?<\/li>(\n|.)*?<\/li>)/gs, (match) => {
                // Si ya está envuelto en <ul>, no hacer nada (simple heurística)
                if (match.startsWith('<ul>') && match.endsWith('</ul>')) return match;
                // Asegura que no envuelva sólo un <li> si no hay más
                if (!match.includes('<li>', match.indexOf('<li>') + 1)) return match;
                return '<ul>' + match + '</ul>';
            });
            // Limpieza de saltos de línea y tags alrededor de <ul>
            html = html.replace(/<br>\s*<ul>/g, '<ul>').replace(/<\/ul>\s*<br>/g, '</ul>');

            // Doble salto de línea (párrafos)
            html = html.replace(/\n\n/g, '</p><p>');

            // Un solo salto de línea (br) - ignora si es dentro de una etiqueta o al principio/final
            html = html.replace(/(?<!\n)\n(?!<)/g, '<br>');

            // Envolver todo el contenido en un tag <p> si no está ya envuelto
            if (!html.startsWith('<p>') && !html.startsWith('<div')) {
                html = `<p>${html}</p>`;
            }

            // Limpieza final de posibles tags sobrantes (ej. <br> al inicio)
            html = html.replace(/^(<br>|\s)*<p>/, '<p>').replace(/<\/p>(<br>|\s)*$/, '</p>');

            // 2. RESTORE: Replace placeholders with raw $$. Remove any <p><br> wrappers introduced around the container.

            // Remove <p><br> at the start
            html = html.replace(/<p><br><div class="math-block-container">/g, '<div class="math-block-container">');
            html = html.replace(/<p><div class="math-block-container">/g, '<div class="math-block-container">');

            // Remove <br></p> at the end
            html = html.replace(/<\/div><br><\/p>/g, '</div>');
            html = html.replace(/<\/div><\/p>/g, '</div>');

            // Restore $$ content
            html = html.replace(/<div class="math-block-container">MATHBLOCK_PLACEHOLDER_(\d+)<\/div>/g, (match, index) => {
                return `$$${mathBlocks[parseInt(index)]}$$`;
            });

            return html;
        };


        // --- Renderizado y Manipulación del DOM ---

        /**
         * Renderiza MathJax para un elemento específico.
         */
        function typesetMathJax(elementId) {
            if (window.isMathJaxReady && window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                const target = elementId ? document.getElementById(elementId) : document.body;
                if (target) {
                    window.MathJax.typesetClear([target]);
                    window.MathJax.typesetPromise([target]).catch(err => console.error('MathJax rendering failed:', err));
                }
            }
        }

        /**
         * Componente: Tarjeta de Tema.
         */
        function renderTopicCard(topic) {
            const {
                id,
                topic: title,
                example,
                status,
                difficulty
            } = topic;

            let statusClasses = 'border-gray-300 bg-white shadow-md hover:shadow-lg';
            let iconName = 'refresh-ccw';
            let iconColor = 'text-gray-400';
            let footerContent = `<span class="text-gray-500 text-xs font-medium">Haz clic para evaluar...</span>`;

            if (status === 'ready') {
                statusClasses = 'border-emerald-600 bg-emerald-50 shadow-lg';
                iconName = 'check-circle';
                iconColor = 'text-emerald-700';
                footerContent = `
                    <div class="flex items-center justify-end">
                        <span class="bg-emerald-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md">¡Lo domino!</span>
                    </div>
                `;
            } else if (status === 'review') {
                statusClasses = 'border-amber-600 bg-amber-50 shadow-lg';
                iconName = 'alert-triangle';
                iconColor = 'text-amber-700';
                footerContent = `
                    <div class="flex items-center justify-between">
                        <span class="bg-amber-400 text-gray-800 px-3 py-1 rounded-full text-xs font-bold shadow-sm">Necesito repasar</span>
                        <button
                            data-topic-id="${id}"
                            onclick="openReviewModal(event, ${id})"
                            class="bg-indigo-700 hover:bg-indigo-800 text-white font-bold py-1 px-3 rounded-full text-xs shadow-md transition duration-150 active:scale-95"
                        >
                            Ayuda IA
                        </button>
                    </div>
                `;
            }

            return `
                <div
                    id="topic-card-${id}"
                    class="topic-card border-l-4 p-5 rounded-xl transition-all duration-300 hover:translate-y-[-3px] ${statusClasses} flex flex-col justify-between h-full cursor-pointer"
                    onclick="toggleTopicStatus(${id})"
                >
                    <div class="flex items-start space-x-4 mb-3">
                        <div class="flex-shrink-0 mt-1">
                            <i data-lucide="${iconName}" class="h-6 w-6 ${iconColor}"></i>
                        </div>
                        <div class="flex-grow">
                            <div class='flex justify-between items-start mb-1'>
                                <h4 class="text-xl font-bold text-gray-900 leading-tight">${title}</h4>
                                ${getDifficultyStars(difficulty)}
                            </div>
                            <p class="text-sm text-gray-700 mt-2">${example}</p>
                        </div>
                    </div>
                    <div class="border-t border-gray-100 pt-3 mt-auto text-right">
                        ${footerContent}
                    </div>
                </div>
            `;
        }

        /**
         * Renderiza un bloque de área completo.
         */
        function renderAreaBlock(area, topics, summary) {
            const readyPercentage = summary.total > 0 ? Math.round((summary.ready / summary.total) * 100) : 0;
            const topicCards = topics.map(renderTopicCard).join('');

            return `
                <div class="area-block space-y-6" data-area="${area}">
                    <div class="p-6 bg-indigo-50 rounded-xl shadow-lg border-l-4 border-indigo-600 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <h2 class="text-2xl font-bold text-indigo-900 mb-3 sm:mb-0" id="area-title-${area.replace(/\s/g, '-')}">
                            ${area} <span class="text-indigo-600 font-medium text-xl">(${summary.ready}/${summary.total} listos)</span>
                        </h2>
                        <div class="w-full sm:w-1/3 mt-2 sm:mt-0">
                            <div class="w-full bg-indigo-200 rounded-full h-3">
                                <div id="progress-area-${area.replace(/\s/g, '-')}" class="progress-fill bg-indigo-600 h-3 rounded-full flex items-center justify-end pr-2 transition-all duration-500" style="width: ${readyPercentage}%">
                                    ${readyPercentage > 10 ? `<span class="text-xs font-bold text-white leading-none">${readyPercentage}%</span>` : ''}
                                </div>
                            </div>
                            ${readyPercentage <= 10 ? `<span class="text-xs font-bold text-indigo-700 leading-none block text-right mt-1">${readyPercentage}%</span>` : ''}
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="topics-grid-${area.replace(/\s/g, '-')}">
                        ${topicCards}
                    </div>
                </div>
            `;
        }

        /**
         * Cálculo de datos derivados.
         */
        function calculateDerivedData() {
            const topics = state.topics;

            const readyCount = topics.filter(t => t.status === 'ready').length;
            const reviewCount = topics.filter(t => t.status === 'review').length;
            const initialCount = topics.filter(t => t.status === 'initial').length;
            const totalTopics = topics.length;
            const readyPercentage = totalTopics > 0 ? Math.round((readyCount / totalTopics) * 100) : 0;

            const uniqueAreas = [...new Set(topics.map(t => t.area))];

            const grouped = topics.reduce((acc, topic) => {
                const area = topic.area;
                if (!acc[area]) acc[area] = {
                    topics: [],
                    ready: 0,
                    total: 0
                };

                // Filtros de visibilidad
                const areaMatch = state.filterArea === 'all' || area === state.filterArea;
                const difficultyMatch = state.filterDifficulty === 'all' || topic.difficulty === state.filterDifficulty;
                const statusMatch = state.filterStatus === 'all' || topic.status === 'all' || topic.status === state.filterStatus;

                if (areaMatch && difficultyMatch && statusMatch) {
                    acc[area].topics.push(topic);
                }

                acc[area].total++;
                if (topic.status === 'ready') acc[area].ready++;

                return acc;
            }, {});

            const finalGroupedTopics = {};
            Object.keys(grouped).forEach(area => {
                if (grouped[area].topics.length > 0) { // Solo muestra áreas con al menos un tema visible
                    finalGroupedTopics[area] = grouped[area];
                }
            });

            return {
                readyCount,
                reviewCount,
                initialCount,
                totalTopics,
                readyPercentage,
                areas: uniqueAreas,
                groupedTopics: finalGroupedTopics
            };
        }

        /**
         * Renderizado completo de la estructura inicial de la aplicación.
         */
        window.initializeAppStructure = () => {
            if (state.hasInitializedStructure) {
                // Si la estructura ya está, solo actualiza el contenido
                return renderApp();
            }

            state.hasInitializedStructure = true;
            const data = calculateDerivedData();
            const {
                readyCount,
                totalTopics,
                areas
            } = data;

            // Renderiza los filtros
            const filterAreaOptions = [{
                value: 'all',
                label: 'Todas las áreas'
            }, ...areas.map(a => ({
                value: a,
                label: a
            }))];
            const filterDifficultyOptions = [{
                    value: 'all',
                    label: 'Toda la dificultad'
                },
                {
                    value: 'easy',
                    label: '★ Fácil'
                },
                {
                    value: 'medium',
                    label: '★★ Medio'
                },
                {
                    value: 'hard',
                    label: '★★★ Difícil'
                },
            ];
            const filterStatusOptions = [{
                    value: 'all',
                    label: 'Todos los estados'
                },
                {
                    value: 'ready',
                    label: '✓ Listos'
                },
                {
                    value: 'review',
                    label: '⚠️ Repasar'
                },
                {
                    value: 'initial',
                    label: '... Pendientes'
                },
            ];

            const filterAreaHTML = renderFilterSelect("Área", state.filterArea, filterAreaOptions, "setFilterArea");
            const filterDifficultyHTML = renderFilterSelect("Dificultad", state.filterDifficulty, filterDifficultyOptions, "setFilterDifficulty");
            const filterStatusHTML = renderFilterSelect("Estado", state.filterStatus, filterStatusOptions, "setFilterStatus");

            const userIdDisplay = state.userId ?
                `<p class="text-xs text-gray-500 mt-2">ID de Usuario: <strong>${state.userId}</strong></p>` :
                `<p class="text-xs text-gray-500 mt-2">Cargando ID de usuario...</p>`;

            const appHtml = `
                <div class="max-w-6xl mx-auto pb-12">
                    <!-- Encabezado Principal -->
                    <header class="text-center mb-10 p-6 bg-white rounded-xl shadow-xl border-t-4 border-indigo-600">
                        <h1 class="text-4xl font-extrabold text-indigo-800 mb-2 flex items-center justify-center">
                            <i data-lucide="rocket" class="h-8 w-8 text-red-600 mr-2 animate-bounce"></i>
                            Test de nivelación: ¿Estás listo para MAE?
                        </h1>
                        <p class="text-gray-700 text-base max-w-4xl mx-auto mt-4 mb-4">
                            Comienza tu experiencia en el IB con confianza. Esta herramienta interactiva te permite <strong>diagnosticar tu nivel</strong> en los <strong>${totalTopics} temas cruciales</strong> de Aritmética, Álgebra, Funciones, Geometría y Estadística, confirmando que estás listo para la exigencia de <strong>Matemáticas: Análisis y Enfoques (MAE)</strong>.
                        </p>
                        <!-- PÁRRAFO DE DESCRIPCIÓN IB MAE (REDUCIDO A 4 LÍNEAS) -->
                        <p class="text-gray-600 text-sm max-w-4xl mx-auto mt-4 mb-4 border-l-4 border-indigo-300 pl-4 py-1 italic bg-indigo-50 rounded-md">
                            El MAE del IB exige fundamentos en Aritmética, Álgebra, Funciones y Geometría/Trigonometría (identidades).<br>
                            Es crucial dominar la Estadística/Probabilidad (media, varianza) y el Análisis/Cálculo básico (derivadas/integrales).<br>
                            Estos pilares sirven de base para los temas profundos del programa y son esenciales para la Exploración.<br>
                            Se conectan con la modelización, el razonamiento riguroso y la exploración de temas avanzados (grafos/SIR).
                        </p>
                        
                        <!-- CONEXIÓN MAE IB (ACTUALIZADO CON NEGRITAS) -->
                        <div class="text-left max-w-4xl mx-auto mt-6 mb-4 p-4 border-l-4 border-pink-500 bg-pink-50 rounded-md shadow-inner">
                            <h4 class="text-lg font-bold text-pink-700 mb-2">Cómo se conectan estos temas con el MAE IB:</h4>
                            <ul class="list-disc ml-6 text-gray-700 space-y-2 text-sm">
                                <li><strong>Punto de partida:</strong> Estos temas son el punto de partida para construir conceptos más avanzados y complejos del curso MAE.</li>
                                <li><strong>Exploración (Evaluación Interna):</strong> Son cruciales para la Exploración, permitiendo a los estudiantes aplicar estos conceptos a problemas del mundo real, como modelos (SIR) o la teoría de grafos.</li>
                                
                                <li><strong>Análisis Riguroso:</strong> El MAE profundiza en Análisis y Enfoques, conectando estos temas con la modelización, el cambio y la generalización, utilizando un razonamiento más riguroso.</li>
                            </ul>
                        </div>
                        
                        <p class="text-gray-700 text-lg font-semibold">
                            Clasifica cada tema según tu nivel: marca <span class="text-[#10b981] font-extrabold">¡Lo domino!</span> si ya lo dominas o <span class="text-[#fbbf24] font-extrabold">Necesito repasar</span> si necesitas refuerzo. Utiliza el botón de <strong>Ayuda IA</strong> para recibir explicaciones instantáneas con IA sobre los puntos que más te cuesten.
                        </p>
                        ${userIdDisplay}
                    </header>
                    
                    <!-- NUEVA IDEA FUERZA DE MOTIVACIÓN -->
                    <div class="max-w-4xl mx-auto mb-10 p-4 bg-indigo-100 rounded-xl shadow-md border-l-4 border-indigo-500 text-center">
                        <p class="text-lg text-indigo-800 font-semibold italic">
                            "El progreso, no la perfección, es lo que define tu éxito en MAE. Los temas que repases son tus mayores oportunidades para crecer. ¡Conviértelos en fortalezas!"
                        </p>
                    </div>

                    <!-- Sección de Resumen Global (Contenedor de actualización) -->
                    <div id="summary-section" class="mb-12 p-6 bg-white rounded-xl shadow-xl border-t-4 border-indigo-600">
                        <!-- El contenido del resumen se actualizará aquí -->
                    </div>

                    <!-- Sección de Controles Globales (Filtros y Reset) -->
                    <div class="flex flex-col lg:flex-row justify-between items-center mb-8 p-4 bg-white rounded-xl shadow-lg space-y-4 lg:space-y-0 lg:space-x-4 border-b-2 border-indigo-200">
                        
                        <!-- Filtros de Selección -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 w-full lg:w-3/4">
                            ${filterAreaHTML}
                            ${filterDifficultyHTML}
                            ${filterStatusHTML}
                        </div>

                        <!-- Botón de Reset -->
                        <button 
                            onclick="handleReset()"
                            class="w-full lg:w-1/4 lg:max-w-[200px] bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150 ease-in-out flex items-center justify-center active:scale-95 text-sm"
                        >
                            <i data-lucide="refresh-ccw" class="h-4 w-4 mr-1"></i>
                            Resetear progreso
                        </button>
                    </div>
                    
                    <!-- Contenedor Principal de Áreas y Temas (Contenedor de actualización) -->
                    <div id="area-container" class="space-y-12 mb-12">
                        <!-- Los bloques de área se renderizarán/actualizarán aquí -->
                    </div>
                    
                    <!-- NUEVA SECCIÓN: GUÍA DE DESPEGUE -->
                    <div id="next-steps-guide" class="max-w-6xl mx-auto p-6 bg-white rounded-xl shadow-xl border-t-4 border-indigo-600 mt-12">
                        <h3 class="text-2xl font-bold text-indigo-800 mb-4 flex items-center">
                            <i data-lucide="chevron-right-square" class="h-6 w-6 text-indigo-600 mr-2"></i>
                            Guía de despegue para MAE
                        </h3>
                        <p class="text-gray-700 mb-4">
                            Aquí tienes tres pasos clave para asegurar tu éxito en el inicio de Matemáticas: Análisis y Enfoques (MAE):
                        </p>
                        <ul class="space-y-4">
                            <li class="p-3 bg-gray-50 border-l-4 border-pink-500 rounded-md shadow-sm">
                                <span class="font-extrabold text-pink-700">1. Prioriza tus debilidades:</span> Enfócate en los temas marcados como <strong>Necesito repasar</strong> (ámbar). Utiliza el <strong>Plan de Estudio IA</strong> para obtener un camino priorizado y la <strong>Ayuda IA</strong> para recursos de práctica instantáneos. No dejes que la base se tambalee.
                            </li>
                            <li class="p-3 bg-gray-50 border-l-4 border-pink-500 rounded-md shadow-sm">
                                <span class="font-extrabold text-pink-700">2. Conecta la teoría con la exploración:</span> Recuerda que en MAE la teoría se aplica a contextos reales. Practica la modelización de problemas de la vida real (física, economía, biología) usando los conceptos básicos que has validado. La fórmula $\text{Velocidad} = \frac{\text{distancia}}{\text{tiempo}}$ es el inicio del concepto de derivada.
                            </li>
                            <li class="p-3 bg-gray-50 border-l-4 border-pink-500 rounded-md shadow-sm">
                                <span class="font-extrabold text-pink-700">3. Mantén la consistencia:</span> La matemática del IB es acumulativa. Dedica bloques de tiempo cortos y frecuentes (20-30 minutos) al repaso, en lugar de sesiones largas y esporádicas. La consistencia es la clave del dominio a largo plazo.
                            </li>
                        </ul>
                    </div>
                    <!-- Fin Guía de Despegue -->
                </div>

                <!-- Footer ACTUALIZADO -->
                <footer class="max-w-6xl mx-auto mt-12 mb-4 p-4 text-center text-xs text-gray-400 border-t border-gray-200 pt-6">
                    <div class="mb-3">
                        <p class="font-bold text-sm text-indigo-600">¡Tu futuro en Matemáticas: Análisis y Enfoques (MAE) te espera!</p>
                        <p class="text-xs text-gray-500 italic mt-1">La excelencia es el resultado de la preparación y la práctica.</p>
                    </div>
                    <div class="border-t border-gray-100 pt-3">
                        <p class="font-medium text-gray-600 mb-1">Recurso de nivelación - Bachillerato Internacional (IB)</p>
                        <p>
                            Elaborado por <a href="https://www.linkedin.com/in/javiertrigosojrtt/" target="_blank" class="text-indigo-600 font-semibold hover:underline">Javier Trigoso</a> | Departamento de Matemáticas HS VCSP | 2025
                        </p>
                        <p class="mt-2 text-xs text-gray-400">Tecnología: Firebase (guardado de progreso), Tailwind CSS (estilo), MathJax (LaTeX) y Google Gemini API (Tutoría IA).</p>
                    </div>
                </footer>
            `;

            document.getElementById('app').innerHTML = appHtml;
            window.createIcons(); // Vuelve a inicializar los íconos de Lucide

            // Renderiza la primera vista con los datos actuales
            renderApp();

            if (window.isMathJaxReady) {
                typesetMathJax('area-container');
            } else {
                document.addEventListener('mathjax-ready', () => typesetMathJax('area-container'));
            }
        };

        /**
         * Renderizado principal de la aplicación. (Solo actualiza el contenido dinámico)
         */
        window.renderApp = () => {
            if (!state.isReady || !state.hasInitializedStructure) {
                return;
            }

            const data = calculateDerivedData();
            updateSummarySection(data);
            updateAreaContainer(data);
            window.createIcons(); // Volver a inicializar los iconos en el contenido actualizado
            typesetMathJax('area-container'); // Renderiza MathJax en el contenido principal actualizado

            // NUEVA LÓGICA DE FINALIZACIÓN
            if (data.readyPercentage === 100 && data.totalTopics > 0) {
                renderCompletionModal(data);
            }
        };

        /**
         * Actualiza la sección de resumen global (contadores y barra).
         */
        function updateSummarySection(data) {
            const {
                readyCount,
                reviewCount,
                totalTopics,
                readyPercentage
            } = data;

            const isCompleted = readyCount === totalTopics && totalTopics > 0;
            updateConfetti(isCompleted);

            let masteryLevel;
            if (readyPercentage < 25) masteryLevel = {
                name: "Nivel 1: Básico (Explorando)",
                color: "text-red-500",
                bar: "bg-red-500"
            };
            else if (readyPercentage < 50) masteryLevel = {
                name: "Nivel 2: Intermedio (Practicando)",
                color: "text-amber-600",
                bar: "bg-amber-500"
            };
            else if (readyPercentage < 75) masteryLevel = {
                name: "Nivel 3: Avanzado (Consolidando)",
                color: "text-indigo-600",
                bar: "bg-indigo-600"
            };
            else if (readyPercentage < 100) masteryLevel = {
                name: "Nivel 4: Experto (Consolidando)",
                color: "text-emerald-600",
                bar: "bg-emerald-600"
            };
            else masteryLevel = {
                name: "Nivel 5: Maestro Absoluto (¡Listo para MAE!)",
                color: "text-emerald-700",
                bar: "bg-emerald-700"
            };

            // Corregir uso de mayúsculas/minúsculas en el resumen
            const summaryHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                    </svg>
                    Tu resumen global
                </h2>
                
                <div class="flex flex-col md:flex-row justify-between items-center space-y-6 md:space-y-0 md:space-x-8">
                    <!-- Contadores de Estado -->
                    <div class="flex justify-around w-full md:w-1/3 space-x-4">
                        <div class="p-4 rounded-xl bg-emerald-100 w-1/2 shadow-md hover:shadow-lg transition">
                            <p class="text-3xl font-bold text-emerald-700">${readyCount}</p>
                            <p class="text-xs text-emerald-800 font-semibold">Temas listos (¡Dominio!)</p>
                        </div>
                        <div class="p-4 rounded-xl bg-amber-100 w-1/2 shadow-md hover:shadow-lg transition">
                            <p class="text-3xl font-bold text-amber-700">${reviewCount}</p>
                            <p class="text-xs text-amber-800 font-semibold">Temas a repasar</p>
                        </div>
                    </div>

                    <!-- Progreso Visual y Nivel de Dominio (MÉTRICA DE DOMINIO) -->
                    <div class="w-full md:w-2/3 p-4 border rounded-xl shadow-inner bg-gray-50">
                        <p class="text-gray-600 mb-2 font-medium text-sm text-center">Nivel de dominio actual:</p>
                        <h3 class="text-xl font-extrabold mb-3 text-center ${masteryLevel.color}">${masteryLevel.name}</h3>

                        <div class="w-full bg-gray-200 rounded-full h-8 overflow-hidden relative">
                            <div id="progress-bar" class="${masteryLevel.bar} h-8 text-xs flex items-center justify-center font-bold text-white p-1 leading-none rounded-full transition-all duration-500" style="width: ${readyPercentage}%">
                                ${readyPercentage}% de avance (${readyCount}/${totalTopics})
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- BOTÓN DE ANÁLISIS IA -->
                <div class="mt-6 flex justify-center">
                    <button
                        onclick="generateStudyPlan()"
                        id="ia-plan-button"
                        class="bg-pink-600 hover:bg-pink-700 disabled:bg-pink-400 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-150 ease-in-out flex items-center text-lg active:scale-95"
                    >
                        <i data-lucide="sparkles" class="h-6 w-6 mr-3"></i>
                        Generar plan de estudio ✨
                    </button>
                </div>
            `;
            document.getElementById('summary-section').innerHTML = summaryHTML;
        }

        /**
         * Actualiza el contenedor principal de áreas y temas.
         */
        function updateAreaContainer(data) {
            const {
                groupedTopics
            } = data;

            // Renderiza los bloques de área
            const areaBlocksHTML = Object.keys(groupedTopics).map(area => {
                const areaData = groupedTopics[area];
                return renderAreaBlock(area, areaData.topics, {
                    ready: areaData.ready,
                    total: areaData.total
                });
            }).join('');

            // Mensaje de no resultados
            const noResultsMessage = Object.keys(groupedTopics).length === 0 ? `
                <div class="p-10 text-center bg-yellow-100 rounded-xl shadow-inner border-l-4 border-yellow-500">
                    <p class="text-xl font-semibold text-yellow-800">No hay temas visibles con los filtros seleccionados.</p>
                    <p class="text-sm text-yellow-700 mt-2">Intenta ajustar los filtros de área, dificultad o estado para ver más temas.</p>
                </div>
            ` : '';

            document.getElementById('area-container').innerHTML = areaBlocksHTML + noResultsMessage;
        }

        /**
         * Componente: Filtro de Selección.
         */
        function renderFilterSelect(label, value, options, onChangeFn) {
            const id = `filter-${label.toLowerCase().replace(/\s/g, '-')}`;
            const optionsHTML = options.map(option =>
                `<option value="${option.value}" ${option.value === value ? 'selected' : ''}>${option.label}</option>`
            ).join('');

            return `
                <div>
                    <label for="${id}" class="block text-xs font-medium text-gray-700 mb-1">${label}</label>
                    <div class="relative">
                        <select
                            id="${id}"
                            onchange="${onChangeFn}(this.value)"
                            class="block w-full py-2 px-3 border border-gray-300 bg-gray-50 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm appearance-none pr-8 transition"
                        >
                            ${optionsHTML}
                        </select>
                        <i data-lucide="chevron-down" class="h-4 w-4 text-gray-500 absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none"></i>
                    </div>
                </div>
            `;
        }

        // --- Manejadores de Eventos Globales ---

        window.toggleTopicStatus = (id) => {
            state.topics = state.topics.map(topic => {
                if (topic.id === id) {
                    let newStatus;
                    if (topic.status === 'initial') newStatus = 'ready';
                    else if (topic.status === 'ready') newStatus = 'review';
                    else newStatus = 'initial';
                    return {
                        ...topic,
                        status: newStatus
                    };
                }
                return topic;
            });
            saveState();
            // renderApp() es llamado por saveState() o por onSnapshot.
        };

        window.setFilterArea = (value) => {
            state.filterArea = value;
            renderApp();
        };

        window.setFilterDifficulty = (value) => {
            state.filterDifficulty = value;
            renderApp();
        };

        window.setFilterStatus = (value) => {
            state.filterStatus = value;
            renderApp();
        };

        window.handleReset = () => {
            state.showResetConfirmation = true;
            renderResetConfirmationModal();
        };

        window.confirmReset = async () => {
            if (window.db && state.userId) {
                try {
                    await window.setDoc(window.doc(window.db, window.getFirestorePath()), {
                        progress: []
                    });
                } catch (e) {
                    console.error("Error al resetear en Firestore:", e);
                }
            }

            localStorage.removeItem(STORAGE_KEY);

            // Resetear estado local para el caso de fallback
            state.topics = INITIAL_TOPICS;
            state.filterArea = 'all';
            state.filterDifficulty = 'all';
            state.filterStatus = 'all';
            state.showResetConfirmation = false;

            closeModal();
            renderApp();
        };

        window.cancelReset = () => {
            state.showResetConfirmation = false;
            closeModal();
        };


        // --- Lógica del Modal (Genérica) ---

        function openModal(contentHtml) {
            const modalRoot = document.getElementById('modal-root');
            modalRoot.innerHTML = contentHtml;
            window.createIcons();
        }

        function closeModal() {
            const modalRoot = document.getElementById('modal-root');
            modalRoot.innerHTML = '';
            state.currentTopicForModal = null;
            // Si el modal de plan de estudio está abierto, resetear su estado de carga
            isPlanLoading = false;
        }

        // --- Modal de Confirmación de Reseteo ---

        function renderResetConfirmationModal() {
            if (!state.showResetConfirmation) return;

            const html = `
                <div 
                    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-70 transition-opacity" 
                    onclick="cancelReset()"
                >
                    <div 
                        class="bg-white rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100 p-6 text-center"
                        onclick="event.stopPropagation()"
                    >
                        <i data-lucide="alert-circle" class="h-12 w-12 text-red-500 mx-auto mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Confirmar reseteo</h3>
                        <p class="text-gray-600 mb-6">
                            ¿Estás seguro de que quieres <strong>resetear todo tu progreso</strong>? Esta acción es irreversible y tu estado actual de la prueba se perderá de forma permanente (incluyendo el guardado en la nube).
                        </p>
                        <div class="flex justify-center space-x-4">
                            <button
                                onclick="cancelReset()"
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition duration-150 active:scale-95"
                            >
                                Cancelar
                            </button>
                            <button
                                onclick="confirmReset()"
                                class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow-md transition duration-150 active:scale-95"
                            >
                                Sí, resetear
                            </button>
                        </div>
                    </div>
                </div>
            `;
            openModal(html);
        }

        // --- Modal de Tutoría IA ---

        let iaContent = 'Presiona el botón para generar un problema de práctica o una explicación.';
        let isLoading = false;

        window.openReviewModal = (event, id) => {
            event.stopPropagation();
            const topic = state.topics.find(t => t.id === id);
            if (!topic) return;
            state.currentTopicForModal = topic;
            iaContent = 'Presiona el botón para generar un problema de práctica o una explicación.';
            renderReviewModal();
        };

        window.renderReviewModal = () => {
            const topic = state.currentTopicForModal;
            if (!topic) return;

            const modalContentId = 'ia-modal-content-area';

            // Renderiza el contenido dinámico del modal (cargando o contenido IA)
            let contentAreaHTML;
            if (isLoading) {
                contentAreaHTML = `
                    <div class="flex items-center justify-center mt-8 p-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                        <span class="ml-3 text-indigo-700 font-medium">Generando contenido...</span>
                    </div>
                `;
            } else {
                contentAreaHTML = `<div class="text-gray-700 leading-relaxed modal-content p-4">${iaContent}</div>`;
            }

            const html = `
                <div 
                    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-70 transition-opacity" 
                    onclick="closeModal()"
                >
                    <div 
                        class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-100 overflow-y-auto max-h-[90vh] text-gray-900"
                        onclick="event.stopPropagation()"
                    >
                        <!-- Encabezado de la Modal -->
                        <div class="flex justify-between items-center p-6 border-b border-indigo-200 bg-indigo-600 rounded-t-xl sticky top-0 z-10">
                            <h3 class="text-xl font-bold text-white">Ayuda rápida: <span class="font-semibold">${topic.topic}</span></h3>
                            <button class="close-button text-indigo-100 hover:text-white transition transform hover:scale-110" onclick="closeModal()">
                                <i data-lucide="x-circle" class="h-6 w-6"></i>
                            </button>
                        </div>
                        
                        <div class="p-4">
                            <p class="text-sm font-semibold text-indigo-600 mb-3 ml-2">Área: ${topic.area} | Dificultad: ${topic.difficulty.toUpperCase()}</p>
                            <div class="text-gray-700 italic mb-4 p-3 border-l-4 border-indigo-300 bg-indigo-50 rounded-md">
                                <p class="text-sm">Ejemplo de aplicación: ${topic.example}</p>
                            </div>

                            <!-- Área de Contenido Generado por IA -->
                            <div id="${modalContentId}" class="bg-gray-100 rounded-lg border border-gray-300 min-h-[150px] pt-4">
                                <h4 class="text-xl font-bold text-gray-800 mb-3 px-4">Recurso de estudio (IA)</h4>
                                ${contentAreaHTML}
                            </div>
                        </div>

                        <!-- Footer de la Modal (Botón de Acción) -->
                        <div class="p-6 border-t border-gray-200 flex justify-end sticky bottom-0 bg-white rounded-b-xl z-10">
                            <button 
                                onclick="generateIaContent()" 
                                ${isLoading ? 'disabled' : ''}
                                class="bg-indigo-700 hover:bg-indigo-800 disabled:bg-indigo-400 text-white font-bold py-2 px-5 rounded-full shadow-lg transition duration-150 ease-in-out flex items-center text-base active:scale-95"
                            >
                                <i data-lucide="zap" class="h-5 w-5 mr-2"></i>
                                ${isLoading ? 'Generando...' : 'Generar recurso IA'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            openModal(html);
            // Renderiza MathJax después de que el modal está en el DOM
            if (!isLoading) {
                setTimeout(() => typesetMathJax(modalContentId), 50);
            }
        };

        window.generateIaContent = async () => {
            const currentTopic = state.currentTopicForModal;
            if (!currentTopic || isLoading) return;

            const topicName = currentTopic.topic.replace(/\$|\\\(|\\\)/g, '').trim();
            const userPrompt = `Genera un problema de práctica conciso y relevante sobre el tema: "${topicName}", de la categoría "${currentTopic.area}". Después de plantear el problema, proporciona la SOLUCIÓN COMPLETA Y DETALLADA, paso a paso. Todo el contenido debe ser de alta calidad y profesional.`;
            const systemPrompt = "Eres un tutor académico de Matemáticas Nivel Superior (IB/Análisis y Enfoques). Tu estilo debe ser cálido, motivador y tutelar, evitando comandos directos o lenguaje imperativo (ej. usa 'Analicemos' en lugar de 'Analice'). El contenido debe ser un texto conciso y bien redactado en español, en formato Markdown. UTILIZA negrita (`**ejemplo**`) ÚNICAMENTE para resaltar el resultado final y la nueva terminología clave (vocabulario). Mantén el texto fluido y natural. Al usar símbolos como $\\mathbb{Q}$ o $\\mathbb{R}$, asegúrate de nombrarlos (ej. 'el conjunto de números racionales, $\\mathbb{Q}$'). Siempre utiliza notación LaTeX para todas las fórmulas matemáticas, tanto en línea (`$...$`) como en bloque (`$$...$$`), asegurando que la notación se integre didácticamente con el texto circundante. Proporciona un problema de práctica y su solución detallada.";

            isLoading = true;
            iaContent = 'Cargando...';
            renderReviewModal(); // Mostrar estado de carga

            let finalContent = "No se pudo generar el contenido. Intenta de nuevo.";

            const payload = {
                contents: [{
                    parts: [{
                        text: userPrompt
                    }]
                }],
                systemInstruction: {
                    parts: [{
                        text: systemPrompt
                    }]
                },
            };

            try {
                const response = await exponentialBackoffFetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                finalContent = result.candidates?.[0]?.content?.parts?.[0]?.text || finalContent;

            } catch (error) {
                console.error('Error al generar contenido de IA:', error);
                // MENSAJE DE ERROR MEJORADO
                finalContent = "Hubo un fallo en la conexión con la IA. Esto puede deberse a un problema de red o un error temporal en el servidor. Por favor, verifica tu conexión a internet e inténtalo de nuevo en unos momentos.";
            } finally {
                isLoading = false;
                iaContent = markdownToHtml(finalContent);
                renderReviewModal(); // Mostrar contenido final
            }
        };

        // --- Lógica del Modal de Plan de Estudio IA (Nueva Característica) ---

        let studyPlanContent = 'Haz clic en el botón para que la IA analice tu progreso y genere un plan de estudio personalizado.';
        let isPlanLoading = false;

        window.renderStudyPlanModal = () => {
            const modalContentId = 'ia-plan-modal-content-area';

            let contentAreaHTML;
            if (isPlanLoading) {
                contentAreaHTML = `
                    <div class="flex items-center justify-center mt-8 p-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-600"></div>
                        <span class="ml-3 text-pink-700 font-medium">Analizando tu progreso y creando el plan...</span>
                    </div>
                `;
            } else {
                contentAreaHTML = `<div class="text-gray-700 leading-relaxed modal-content p-4">${studyPlanContent}</div>`;
            }

            const html = `
                <div 
                    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-70 transition-opacity" 
                    onclick="closeModal()"
                >
                    <div 
                        class="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all duration-300 scale-100 overflow-y-auto max-h-[90vh] text-gray-900"
                        onclick="event.stopPropagation()"
                    >
                        <!-- Encabezado de la Modal -->
                        <div class="flex justify-between items-center p-6 border-b border-pink-200 bg-pink-600 rounded-t-xl sticky top-0 z-10">
                            <h3 class="text-xl font-bold text-white">Plan de estudio personalizado ✨</h3>
                            <button class="close-button text-pink-100 hover:text-white transition transform hover:scale-110" onclick="closeModal()">
                                <i data-lucide="x-circle" class="h-6 w-6"></i>
                            </button>
                        </div>
                        
                        <div class="p-4">
                            <!-- Área de Contenido Generado por IA -->
                            <div id="${modalContentId}" class="bg-gray-100 rounded-lg border border-gray-300 min-h-[150px] pt-4">
                                <h4 class="text-xl font-bold text-gray-800 mb-3 px-4 flex items-center"><i data-lucide="brain-circuit" class="h-6 w-6 mr-2 text-pink-600"></i> Análisis de fortalezas y debilidades</h4>
                                ${contentAreaHTML}
                            </div>
                        </div>

                        <!-- Footer de la Modal (Botón de Re-Acción) -->
                        <div class="p-6 border-t border-gray-200 flex justify-end sticky bottom-0 bg-white rounded-b-xl z-10">
                            <button 
                                onclick="generateStudyPlan()" 
                                ${isPlanLoading ? 'disabled' : ''}
                                class="bg-pink-600 hover:bg-pink-700 disabled:bg-pink-400 text-white font-bold py-2 px-5 rounded-full shadow-lg transition duration-150 ease-in-out flex items-center text-base active:scale-95"
                            >
                                <i data-lucide="zap" class="h-5 w-5 mr-2"></i>
                                ${isPlanLoading ? 'Analizando...' : 'Regenerar plan de estudio'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            openModal(html);
            if (!isPlanLoading) {
                setTimeout(() => typesetMathJax(modalContentId), 50);
            }
        };

        window.generateStudyPlan = async () => {
            if (isPlanLoading) return;

            const data = calculateDerivedData();
            const reviewTopics = state.topics.filter(t => t.status === 'review');
            const readyTopics = state.topics.filter(t => t.status === 'ready');

            const reviewList = reviewTopics.map(t => `${t.area}: ${t.topic} (${t.difficulty})`).join(', ');
            const readyList = readyTopics.map(t => `${t.area}: ${t.topic}`).join(', ');

            // Mostrar el modal y el estado de carga
            isPlanLoading = true;
            studyPlanContent = 'Cargando...';
            window.renderStudyPlanModal();

            let finalContent = "No se pudo generar el plan de estudio. Intenta de nuevo.";

            const userPrompt = `Analiza el siguiente progreso de un estudiante que se prepara para el curso de Matemáticas: Análisis y Enfoques (MAE) del IB.
                - Temas que necesita **REPASAR** (Debilidades): ${reviewList || 'Ninguno'}
                - Temas que **DOMINA** (Fortalezas): ${readyList || 'Ninguno'}
                
                Instrucciones:
                1. **Análisis de la situación:** Evalúa el estado general de preparación (fuerte, intermedio, crítico).
                2. **Priorización:** Identifica los 3 a 5 temas más críticos de la lista de 'REPASAR' que deben ser abordados primero (priorizando dificultad media o alta si están presentes).
                3. **Plan de Estudio:** Genera un plan de estudio concreto de 3 pasos (Máximo 3 oraciones por paso) para el estudiante basado en sus debilidades, incluyendo una meta para la próxima semana.
                `;

            const systemPrompt = "Eres un consultor experto del Bachillerato Internacional (IB) en Matemáticas: Análisis y Enfoques (MAE). Tu objetivo es proporcionar una guía de estudio personalizada y motivadora. El contenido debe ser un reporte didáctico y profesional en español. Usa encabezados en Markdown (`#`, `##`) para estructurar la respuesta y negrita (`**`) para resaltar puntos clave. NUNCA uses fórmulas LaTeX en la respuesta, solo texto plano y listas Markdown. Debes ser conciso y motivador.";

            const payload = {
                contents: [{
                    parts: [{
                        text: userPrompt
                    }]
                }],
                systemInstruction: {
                    parts: [{
                        text: systemPrompt
                    }]
                },
            };

            try {
                const response = await exponentialBackoffFetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                finalContent = result.candidates?.[0]?.content?.parts?.[0]?.text || finalContent;

            } catch (error) {
                console.error('Error al generar Plan de Estudio IA:', error);
                finalContent = "Hubo un fallo en la conexión con la IA. Esto puede deberse a un problema de red o un error temporal en el servidor. Por favor, verifica tu conexión a internet e inténtalo de nuevo en unos momentos.";
            } finally {
                isPlanLoading = false;
                studyPlanContent = markdownToHtml(finalContent);
                window.renderStudyPlanModal(); // Mostrar contenido final
            }
        };

        // --- Modal de Finalización (Nuevo) ---

        window.renderCompletionModal = (data) => {
            const {
                readyCount,
                reviewCount,
                totalTopics
            } = data;

            if (reviewCount > 0) return; // Si hay temas pendientes de revisión, no mostrar el certificado.

            const readyTopics = state.topics.filter(t => t.status === 'ready');
            const sortedTopics = readyTopics.sort((a, b) => {
                const areaA = a.area.localeCompare(b.area);
                if (areaA !== 0) return areaA;
                return a.topic.localeCompare(b.topic);
            });

            // Renderiza la lista de temas en HTML (será procesada por MathJax después)
            // Se usa el span con la clase topic-math-ready para que MathJax sepa dónde buscar LaTeX.
            const topicListHtml = sortedTopics.map(t =>
                `<li class="flex items-start text-sm text-gray-700">
                    <i data-lucide="check-circle" class="h-4 w-4 mr-2 text-emerald-500 flex-shrink-0 mt-1"></i>
                    <span class="topic-math-ready">${t.topic}</span> (${t.area})
                </li>`
            ).join('');

            const html = `
                <div 
                    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-70 transition-opacity" 
                    onclick="closeModal()"
                >
                    <div 
                        id="completion-modal-container"
                        class="bg-white rounded-xl shadow-2xl w-full max-w-3xl transform transition-all duration-300 scale-100 overflow-y-auto max-h-[90vh] text-gray-900 border-t-8 border-emerald-500"
                        onclick="event.stopPropagation()"
                    >
                        <!-- Encabezado de la Modal -->
                        <div class="text-center p-8 bg-emerald-50 rounded-t-xl">
                            <i data-lucide="trophy" class="h-16 w-16 text-emerald-600 mx-auto mb-4 animate-bounce"></i>
                            <h3 class="text-3xl font-extrabold text-emerald-800 mb-2">¡Felicitaciones! Dominio completo</h3>
                            <p class="text-lg text-emerald-700">Has completado tu test de nivelación de Matemáticas MAE.</p>
                        </div>
                        
                        <div class="p-8">
                            <div class="bg-gray-100 p-6 rounded-lg mb-6 shadow-inner">
                                <h4 class="text-xl font-bold text-gray-800 mb-3 flex items-center"><i data-lucide="file-text" class="h-5 w-5 mr-2 text-indigo-600"></i> Reporte de preparación</h4>
                                <p class="text-gray-700">Has revisado y validado el dominio de <strong>${readyCount} de ${totalTopics} temas</strong> críticos para el curso de Análisis y Enfoques (MAE).</p>
                                <div class="mt-4 border-t pt-4">
                                    <h5 class="text-lg font-semibold text-indigo-700 mb-2">Temas dominados:</h5>
                                    <ul id="completion-topic-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-60 overflow-y-auto">
                                        ${topicListHtml}
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Certificado de Preparación -->
                            <div class="border-2 border-dashed border-emerald-500 p-6 rounded-xl text-center bg-white">
                                <p class="text-lg font-bold text-gray-800 mb-1">Certificado de preparación</p>
                                <p class="text-2xl font-extrabold text-emerald-600">Nivel: Maestro absoluto</p>
                                <p class="text-sm text-gray-500 mt-2">Este resultado confirma tu fuerte base para iniciar el Nivel Superior del programa IB MAE.</p>
                                <i data-lucide="check-shield" class="h-12 w-12 text-emerald-600 mx-auto mt-4"></i>
                            </div>
                        </div>

                        <!-- Footer de la Modal -->
                        <div class="p-6 border-t border-gray-200 flex justify-end bg-white rounded-b-xl">
                            <button 
                                onclick="closeModal()" 
                                class="bg-indigo-700 hover:bg-indigo-800 text-white font-bold py-2 px-5 rounded-full shadow-lg transition duration-150 ease-in-out active:scale-95"
                            >
                                Cerrar y continuar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            openModal(html);

            // Procesar MathJax en el contenido de la lista después de que se muestra el modal
            typesetMathJax('completion-modal-container');
        };

        // --- Confetti ---

        function updateConfetti(isCompleted) {
            const confettiContainer = document.getElementById('confetti-container');
            if (isCompleted) {
                confettiContainer.classList.remove('hidden');
                if (confettiContainer.children.length === 0) {
                    for (let i = 0; i < 50; i++) {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti absolute w-2 h-2 rounded-full opacity-0';
                        confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                        confetti.style.left = `${Math.random() * 100}vw`;
                        confetti.style.top = `-10px`;
                        conffetti.style.animation = `fall ${2 + Math.random() * 2}s linear ${Math.random() * 3}s infinite`;
                        confetti.style.setProperty('--rand-x', Math.random() < 0.5 ? '1' : '-1');
                        confettiContainer.appendChild(confetti);
                    }
                }
            } else {
                confettiContainer.classList.add('hidden');
                confettiContainer.innerHTML = '';
            }
        }


        window.onload = function() {
            // Si la lógica de Firebase no inicializa initializeAppStructure (ej. en modo fallback), lo hacemos aquí.
            if (!window.db) {
                if (window.isMathJaxReady) {
                    window.initializeAppStructure();
                } else {
                    document.addEventListener('mathjax-ready', window.initializeAppStructure);
                }
            }
        };
    </script>
</body>

</html>

